#lang typed/racket

;; this file maps subject/number pairs to canonical ids.
;; at this point, it's sort of turning into a thin wrapper
;; for the scheduling database.

(provide canonicalize
         canonical-id?
         ensure-canonical
         courses-in-subject
         id-mappings
         Subject
         CourseNum
         CatalogCycle
         CourseID
         catalog-cycle?
         subject?)

(require/typed
 db
 [#:opaque Connection connection?]
 [postgresql-connect
  (#:port Number #:user String #:database String #:password String
   -> Connection)]
 [query-rows
  (Connection String Any * -> (Listof (Vectorof Any)))]
 [query-list
  (Connection String Any * -> (Listof Any))])

(require "credentials.rkt")

(define-type Subject (U "CPE" "CSC" "HNRS" "ART" "EE" "IME" "MATE"
                        "DATA"))
(define-type CourseNum String) ;; such as "123" or "0123"
(define-type CatalogCycle (U "2007-2009" "2009-2011" "2011-2013" "2013-2015" "2015-2017"
                             "2017-2019"))

(define-type CourseID String) ;; such as "csc123"

(define-type MappingRow (Vector CatalogCycle Subject CourseNum CourseID))

(define-predicate catalog-cycle? CatalogCycle)
(define-predicate subject? Subject)

(: mapping-row-id (MappingRow -> CourseID))
(define (mapping-row-id r)
  (vector-ref r 3))

;; this can't be captured by a TR type
(: coursenum? (String -> Boolean))
(define (coursenum? s)
  (regexp-match? #px"^0?[0-9]{3}( +X)?$" s))

(define use-cached-mappings? #f)

(define cache-date "2017-05-17")
(define cached-mappings
  '(#("2017-2019" "CPE" "101" "csc101")
    #("2017-2019" "CSC" "101" "csc101")
    #("2017-2019" "CPE" "105" "csc105")
    #("2017-2019" "CSC" "105" "csc105")
    #("2017-2019" "CPE" "108" "csc108")
    #("2017-2019" "CSC" "108" "csc108")
    #("2017-2019" "CPE" "123" "csc123")
    #("2017-2019" "CSC" "123" "csc123")
    #("2017-2019" "CSC" "171" "csc171")
    #("2017-2019" "CSC" "200" "csc200")
    #("2017-2019" "CPE" "202" "csc202")
    #("2017-2019" "CSC" "202" "csc202")
    #("2017-2019" "CPE" "203" "csc203")
    #("2017-2019" "CSC" "203" "csc203")
    #("2017-2019" "CSC" "209" "csc209")
    #("2017-2019" "CSC" "225" "csc225")
    #("2017-2019" "CSC" "231" "csc231")
    #("2017-2019" "CSC" "232" "csc232")
    #("2017-2019" "CSC" "234" "csc234")
    #("2017-2019" "CSC" "235" "csc235")
    #("2017-2019" "CSC" "236" "csc236")
    #("2017-2019" "CSC" "290" "csc290")
    #("2017-2019" "CSC" "300" "csc300")
    #("2017-2019" "CSC" "301" "csc301")
    #("2017-2019" "CSC" "302" "csc302")
    #("2017-2019" "CSC" "303" "csc303")
    #("2017-2019" "CSC" "305" "csc305")
    #("2017-2019" "CSC" "307" "csc307")
    #("2017-2019" "CSC" "308" "csc308")
    #("2017-2019" "CSC" "309" "csc309")
    #("2017-2019" "CSC" "310" "csc310")
    #("2017-2019" "HNRS" "311" "csc310")
    #("2017-2019" "CSC" "311" "csc311")
    #("2017-2019" "CSC" "320" "csc320")
    #("2017-2019" "CPE" "321" "csc321")
    #("2017-2019" "CSC" "321" "csc321")
    #("2017-2019" "CSC" "323" "csc323")
    #("2017-2019" "CSC" "325" "csc325")
    #("2017-2019" "CSC" "344" "csc344")
    #("2017-2019" "CSC" "348" "csc348")
    #("2017-2019" "CSC" "349" "csc349")
    #("2017-2019" "ART" "350" "csc350")
    #("2017-2019" "CSC" "350" "csc350")
    #("2017-2019" "CPE" "357" "csc357")
    #("2017-2019" "CSC" "357" "csc357")
    #("2017-2019" "CSC" "365" "csc365")
    #("2017-2019" "CSC" "366" "csc366")
    #("2017-2019" "CSC" "369" "csc369")
    #("2017-2019" "CSC" "371" "csc371")
    #("2017-2019" "CSC" "378" "csc378")
    #("2017-2019" "CSC" "400" "csc400")
    #("2017-2019" "CSC" "402" "csc402")
    #("2017-2019" "CSC" "405" "csc405")
    #("2017-2019" "CSC" "406" "csc406")
    #("2017-2019" "CSC" "409" "csc409")
    #("2017-2019" "CSC" "410" "csc410")
    #("2017-2019" "CPE" "422" "csc422")
    #("2017-2019" "CSC" "422" "csc422")
    #("2017-2019" "CSC" "424" "csc424")
    #("2017-2019" "CSC" "429" "csc429")
    #("2017-2019" "CSC" "430" "csc430")
    #("2017-2019" "CPE" "431" "csc431")
    #("2017-2019" "CSC" "431" "csc431")
    #("2017-2019" "CSC" "435" "csc435")
    #("2017-2019" "CSC" "436" "csc436")
    #("2017-2019" "CSC" "437" "csc437")
    #("2017-2019" "CSC" "445" "csc445")
    #("2017-2019" "CSC" "448" "csc448")
    #("2017-2019" "ART" "450" "csc450")
    #("2017-2019" "CSC" "450" "csc450")
    #("2017-2019" "CPE" "453" "csc453")
    #("2017-2019" "CSC" "453" "csc453")
    #("2017-2019" "CPE" "454" "csc454")
    #("2017-2019" "CSC" "454" "csc454")
    #("2017-2019" "CPE" "458" "csc458")
    #("2017-2019" "CSC" "458" "csc458")
    #("2017-2019" "CSC" "466" "csc466")
    #("2017-2019" "CSC" "468" "csc468")
    #("2017-2019" "CSC" "469" "csc469")
    #("2017-2019" "CPE" "469" "csc469")
    #("2017-2019" "CPE" "471" "csc471")
    #("2017-2019" "CSC" "471" "csc471")
    #("2017-2019" "CSC" "473" "csc473")
    #("2017-2019" "CSC" "474" "csc474")
    #("2017-2019" "CPE" "476" "csc476")
    #("2017-2019" "CSC" "476" "csc476")
    #("2017-2019" "CSC" "477" "csc477")
    #("2017-2019" "CSC" "478" "csc478")
    #("2017-2019" "CSC" "480" "csc480")
    #("2017-2019" "CSC" "481" "csc481")
    #("2017-2019" "CSC" "483" "csc483")
    #("2017-2019" "CSC" "484" "csc484")
    #("2017-2019" "CSC" "486" "csc486")
    #("2017-2019" "CSC" "489" "csc489")
    #("2017-2019" "CSC" "490" "csc490")
    #("2017-2019" "CSC" "491" "csc491")
    #("2017-2019" "CSC" "492" "csc492")
    #("2017-2019" "CSC" "493" "csc493")
    #("2017-2019" "CSC" "494" "csc494")
    #("2017-2019" "CSC" "495" "csc495")
    #("2017-2019" "CSC" "496" "csc496")
    #("2017-2019" "CSC" "500" "csc500")
    #("2017-2019" "CSC" "508" "csc508")
    #("2017-2019" "CSC" "509" "csc509")
    #("2017-2019" "CPE" "515" "csc515")
    #("2017-2019" "CSC" "515" "csc515")
    #("2017-2019" "CSC" "521" "csc521")
    #("2017-2019" "CSC" "530" "csc530")
    #("2017-2019" "CSC" "540" "csc540")
    #("2017-2019" "CSC" "550" "csc550")
    #("2017-2019" "CSC" "560" "csc560")
    #("2017-2019" "CPE" "564" "csc564")
    #("2017-2019" "CSC" "564" "csc564")
    #("2017-2019" "CSC" "566" "csc566")
    #("2017-2019" "CPE" "569" "csc569")
    #("2017-2019" "CSC" "569" "csc569")
    #("2017-2019" "CSC" "570" "csc570")
    #("2017-2019" "CSC" "572" "csc572")
    #("2017-2019" "CSC" "580" "csc580")
    #("2017-2019" "CSC" "581" "csc581")
    #("2017-2019" "CSC" "582" "csc582")
    #("2017-2019" "CSC" "590" "csc590")
    #("2017-2019" "CSC" "593" "csc593")
    #("2017-2019" "CSC" "594" "csc594")
    #("2017-2019" "CSC" "595" "csc595")
    #("2017-2019" "CSC" "596" "csc596")
    #("2017-2019" "CSC" "597" "csc597")
    #("2017-2019" "CSC" "599" "csc599")
    #("2017-2019" "CPE" "100" "cpe100")
    #("2017-2019" "CPE" "133" "cpe133")
    #("2017-2019" "EE" "133" "cpe133")
    #("2017-2019" "CPE" "200" "cpe200")
    #("2017-2019" "CPE" "233" "cpe233")
    #("2017-2019" "EE" "233" "cpe233")
    #("2017-2019" "CPE" "290" "cpe290")
    #("2017-2019" "CPE" "315" "cpe315")
    #("2017-2019" "CPE" "328" "cpe328")
    #("2017-2019" "EE" "328" "cpe328")
    #("2017-2019" "CPE" "329" "cpe329")
    #("2017-2019" "EE" "329" "cpe329")
    #("2017-2019" "CPE" "336" "cpe336")
    #("2017-2019" "EE" "336" "cpe336")
    #("2017-2019" "CPE" "350" "cpe350")
    #("2017-2019" "CPE" "368" "cpe368")
    #("2017-2019" "EE" "368" "cpe368")
    #("2017-2019" "CPE" "400" "cpe400")
    #("2017-2019" "CPE" "416" "cpe416")
    #("2017-2019" "CPE" "419" "cpe419")
    #("2017-2019" "CPE" "428" "cpe428")
    #("2017-2019" "EE" "428" "cpe428")
    #("2017-2019" "CPE" "432" "cpe432")
    #("2017-2019" "EE" "432" "cpe432")
    #("2017-2019" "CPE" "439" "cpe439")
    #("2017-2019" "EE" "439" "cpe439")
    #("2017-2019" "CPE" "441" "cpe441")
    #("2017-2019" "EE" "431" "cpe441")
    #("2017-2019" "CPE" "450" "cpe450")
    #("2017-2019" "CPE" "461" "cpe461")
    #("2017-2019" "CPE" "462" "cpe462")
    #("2017-2019" "CPE" "464" "cpe464")
    #("2017-2019" "CPE" "465" "cpe465")
    #("2017-2019" "CPE" "470" "cpe470")
    #("2017-2019" "CPE" "472" "cpe472")
    #("2017-2019" "EE" "472" "cpe472")
    #("2017-2019" "CPE" "479" "cpe479")
    #("2017-2019" "CPE" "482" "cpe482")
    #("2017-2019" "CPE" "485" "cpe485")
    #("2017-2019" "CPE" "488" "cpe488")
    #("2017-2019" "IME" "458" "cpe488")
    #("2017-2019" "MATE" "458" "cpe488")
    #("2017-2019" "CPE" "493" "cpe493")
    #("2017-2019" "CPE" "494" "cpe494")
    #("2017-2019" "CPE" "495" "cpe495")
    #("2017-2019" "CPE" "521" "cpe521")
    #("2017-2019" "EE" "521" "cpe521")
    #("2017-2019" "CPE" "522" "cpe522")
    #("2017-2019" "EE" "522" "cpe522")
    #("2017-2019" "CPE" "523" "cpe523")
    #("2017-2019" "EE" "523" "cpe523")
    #("2015-2017" "CPE" "101" "csc101")
    #("2015-2017" "CSC" "101" "csc101")
    #("2015-2017" "CPE" "102" "csc102")
    #("2015-2017" "CSC" "102" "csc102")
    #("2015-2017" "CPE" "103" "csc103")
    #("2015-2017" "CSC" "103" "csc103")
    #("2015-2017" "CPE" "105" "csc105")
    #("2015-2017" "CSC" "105" "csc105")
    #("2015-2017" "CPE" "108" "csc108")
    #("2015-2017" "CSC" "108" "csc108")
    #("2015-2017" "CPE" "123" "csc123")
    #("2015-2017" "CSC" "123" "csc123")
    #("2015-2017" "CSC" "171" "csc171")
    #("2015-2017" "CSC" "200" "csc200")
    #("2015-2017" "CPE" "209" "csc209")
    #("2015-2017" "CSC" "209" "csc209")
    #("2015-2017" "CPE" "225" "csc225")
    #("2015-2017" "CSC" "225" "csc225")
    #("2015-2017" "CSC" "231" "csc231")
    #("2015-2017" "CSC" "232" "csc232")
    #("2015-2017" "CSC" "234" "csc234")
    #("2015-2017" "CPE" "235" "csc235")
    #("2015-2017" "CSC" "235" "csc235")
    #("2015-2017" "CPE" "236" "csc236")
    #("2015-2017" "CSC" "236" "csc236")
    #("2015-2017" "CSC" "290" "csc290")
    #("2015-2017" "CPE" "300" "csc300")
    #("2015-2017" "CSC" "300" "csc300")
    #("2015-2017" "CPE" "301" "csc301")
    #("2015-2017" "CSC" "301" "csc301")
    #("2015-2017" "CSC" "302" "csc302")
    #("2015-2017" "CSC" "303" "csc303")
    #("2015-2017" "CPE" "305" "csc305")
    #("2015-2017" "CSC" "305" "csc305")
    #("2015-2017" "CPE" "307" "csc307")
    #("2015-2017" "CSC" "307" "csc307")
    #("2015-2017" "CPE" "308" "csc308")
    #("2015-2017" "CSC" "308" "csc308")
    #("2015-2017" "CPE" "309" "csc309")
    #("2015-2017" "CSC" "309" "csc309")
    #("2015-2017" "CSC" "310" "csc310")
    #("2015-2017" "HNRS" "311" "csc310")
    #("2015-2017" "CSC" "311" "csc311")
    #("2015-2017" "CPE" "315" "cpe315")
    #("2015-2017" "CSC" "315" "cpe315")
    #("2015-2017" "CSC" "320" "csc320")
    #("2015-2017" "CPE" "321" "csc321")
    #("2015-2017" "CSC" "321" "csc321")
    #("2015-2017" "CSC" "323" "csc323")
    #("2015-2017" "CSC" "341" "csc341")
    #("2015-2017" "CPE" "344" "csc344")
    #("2015-2017" "CSC" "344" "csc344")
    #("2015-2017" "CSC" "348" "csc348")
    #("2015-2017" "CPE" "349" "csc349")
    #("2015-2017" "CSC" "349" "csc349")
    #("2015-2017" "ART" "350" "csc350")
    #("2015-2017" "CSC" "350" "csc350")
    #("2015-2017" "CPE" "357" "csc357")
    #("2015-2017" "CSC" "357" "csc357")
    #("2015-2017" "CSC" "358" "csc358")
    #("2015-2017" "CPE" "365" "csc365")
    #("2015-2017" "CSC" "365" "csc365")
    #("2015-2017" "CPE" "366" "csc366")
    #("2015-2017" "CSC" "366" "csc366")
    #("2015-2017" "CPE" "369" "csc369")
    #("2015-2017" "CSC" "369" "csc369")
    #("2015-2017" "CSC" "371" "csc371")
    #("2015-2017" "CPE" "378" "csc378")
    #("2015-2017" "CSC" "378" "csc378")
    #("2015-2017" "CSC" "400" "csc400")
    #("2015-2017" "CPE" "402" "csc402")
    #("2015-2017" "CSC" "402" "csc402")
    #("2015-2017" "CPE" "405" "csc405")
    #("2015-2017" "CSC" "405" "csc405")
    #("2015-2017" "CPE" "406" "csc406")
    #("2015-2017" "CSC" "406" "csc406")
    #("2015-2017" "CPE" "409" "csc409")
    #("2015-2017" "CSC" "409" "csc409")
    #("2015-2017" "CSC" "410" "csc410")
    #("2015-2017" "CPE" "416" "cpe416")
    #("2015-2017" "CSC" "416" "cpe416")
    #("2015-2017" "CPE" "419" "cpe419")
    #("2015-2017" "CSC" "419" "cpe419")
    #("2015-2017" "CSC" "424" "csc424")
    #("2015-2017" "CSC" "429" "csc429")
    #("2015-2017" "CPE" "430" "csc430")
    #("2015-2017" "CSC" "430" "csc430")
    #("2015-2017" "CPE" "431" "csc431")
    #("2015-2017" "CSC" "431" "csc431")
    #("2015-2017" "CPE" "435" "csc435")
    #("2015-2017" "CSC" "435" "csc435")
    #("2015-2017" "CPE" "436" "csc436")
    #("2015-2017" "CSC" "436" "csc436")
    #("2015-2017" "CPE" "437" "csc437")
    #("2015-2017" "CSC" "437" "csc437")
    #("2015-2017" "CSC" "445" "csc445")
    #("2015-2017" "CPE" "448" "csc448")
    #("2015-2017" "CSC" "448" "csc448")
    #("2015-2017" "ART" "450" "csc450")
    #("2015-2017" "CSC" "450" "csc450")
    #("2015-2017" "CPE" "453" "csc453")
    #("2015-2017" "CSC" "453" "csc453")
    #("2015-2017" "CPE" "454" "csc454")
    #("2015-2017" "CSC" "454" "csc454")
    #("2015-2017" "CPE" "458" "csc458")
    #("2015-2017" "CSC" "458" "csc458")
    #("2015-2017" "CPE" "464" "cpe464")
    #("2015-2017" "CSC" "464" "cpe464")
    #("2015-2017" "CPE" "465" "cpe465")
    #("2015-2017" "CSC" "465" "cpe465")
    #("2015-2017" "CPE" "466" "csc466")
    #("2015-2017" "CSC" "466" "csc466")
    #("2015-2017" "CPE" "468" "csc468")
    #("2015-2017" "CSC" "468" "csc468")
    #("2015-2017" "CPE" "471" "csc471")
    #("2015-2017" "CSC" "471" "csc471")
    #("2015-2017" "CPE" "473" "csc473")
    #("2015-2017" "CSC" "473" "csc473")
    #("2015-2017" "CPE" "474" "csc474")
    #("2015-2017" "CSC" "474" "csc474")
    #("2015-2017" "CPE" "476" "csc476")
    #("2015-2017" "CSC" "476" "csc476")
    #("2015-2017" "CSC" "477" "csc477")
    #("2015-2017" "CPE" "478" "csc478")
    #("2015-2017" "CSC" "478" "csc478")
    #("2015-2017" "CSC" "479" "csc479")
    #("2015-2017" "CPE" "480" "csc480")
    #("2015-2017" "CSC" "480" "csc480")
    #("2015-2017" "CPE" "481" "csc481")
    #("2015-2017" "CSC" "481" "csc481")
    #("2015-2017" "CPE" "483" "csc483")
    #("2015-2017" "CSC" "483" "csc483")
    #("2015-2017" "CPE" "484" "csc484")
    #("2015-2017" "CSC" "484" "csc484")
    #("2015-2017" "CPE" "485" "cpe485")
    #("2015-2017" "CSC" "485" "cpe485")
    #("2015-2017" "CSC" "486" "csc486")
    #("2015-2017" "CPE" "486" "csc486")
    #("2015-2017" "CPE" "489" "csc489")
    #("2015-2017" "CSC" "489" "csc489")
    #("2015-2017" "CSC" "490" "csc490")
    #("2015-2017" "CSC" "491" "csc491")
    #("2015-2017" "CSC" "492" "csc492")
    #("2015-2017" "CSC" "493" "csc493")
    #("2015-2017" "CSC" "494" "csc494")
    #("2015-2017" "CSC" "495" "csc495")
    #("2015-2017" "CSC" "496" "csc496")
    #("2015-2017" "CSC" "500" "csc500")
    #("2015-2017" "CSC" "508" "csc508")
    #("2015-2017" "CSC" "509" "csc509")
    #("2015-2017" "CPE" "515" "csc515")
    #("2015-2017" "CSC" "515" "csc515")
    #("2015-2017" "CSC" "521" "csc521")
    #("2015-2017" "CSC" "530" "csc530")
    #("2015-2017" "CSC" "540" "csc540")
    #("2015-2017" "CSC" "550" "csc550")
    #("2015-2017" "CSC" "560" "csc560")
    #("2015-2017" "CPE" "564" "csc564")
    #("2015-2017" "CSC" "564" "csc564")
    #("2015-2017" "CSC" "566" "csc566")
    #("2015-2017" "CPE" "569" "csc569")
    #("2015-2017" "CSC" "569" "csc569")
    #("2015-2017" "CSC" "570" "csc570")
    #("2015-2017" "CSC" "572" "csc572")
    #("2015-2017" "CPE" "580" "csc580")
    #("2015-2017" "CSC" "580" "csc580")
    #("2015-2017" "CPE" "581" "csc581")
    #("2015-2017" "CSC" "581" "csc581")
    #("2015-2017" "CSC" "582" "csc582")
    #("2015-2017" "CSC" "590" "csc590")
    #("2015-2017" "CSC" "593" "csc593")
    #("2015-2017" "CSC" "594" "csc594")
    #("2015-2017" "CSC" "595" "csc595")
    #("2015-2017" "CSC" "596" "csc596")
    #("2015-2017" "CSC" "597" "csc597")
    #("2015-2017" "CSC" "599" "csc599")
    #("2015-2017" "CPE" "100" "cpe100")
    #("2015-2017" "CPE" "133" "cpe133")
    #("2015-2017" "EE" "133" "cpe133")
    #("2015-2017" "CPE" "200" "cpe200")
    #("2015-2017" "CPE" "233" "cpe233")
    #("2015-2017" "EE" "233" "cpe233")
    #("2015-2017" "CPE" "290" "cpe290")
    #("2015-2017" "CPE" "328" "cpe328")
    #("2015-2017" "EE" "328" "cpe328")
    #("2015-2017" "CPE" "329" "cpe329")
    #("2015-2017" "EE" "329" "cpe329")
    #("2015-2017" "CPE" "336" "cpe336")
    #("2015-2017" "EE" "336" "cpe336")
    #("2015-2017" "CPE" "350" "cpe350")
    #("2015-2017" "CPE" "368" "cpe368")
    #("2015-2017" "EE" "368" "cpe368")
    #("2015-2017" "CPE" "400" "cpe400")
    #("2015-2017" "CPE" "428" "cpe428")
    #("2015-2017" "EE" "428" "cpe428")
    #("2015-2017" "CPE" "432" "cpe432")
    #("2015-2017" "EE" "432" "cpe432")
    #("2015-2017" "CPE" "439" "cpe439")
    #("2015-2017" "EE" "439" "cpe439")
    #("2015-2017" "CPE" "441" "cpe441")
    #("2015-2017" "EE" "431" "cpe441")
    #("2015-2017" "CPE" "450" "cpe450")
    #("2015-2017" "CPE" "461" "cpe461")
    #("2015-2017" "CPE" "462" "cpe462")
    #("2015-2017" "CPE" "470" "cpe470")
    #("2015-2017" "CPE" "472" "cpe472")
    #("2015-2017" "EE" "472" "cpe472")
    #("2015-2017" "CPE" "479" "cpe479")
    #("2015-2017" "CPE" "482" "cpe482")
    #("2015-2017" "CPE" "488" "cpe488")
    #("2015-2017" "IME" "458" "cpe488")
    #("2015-2017" "MATE" "458" "cpe488")
    #("2015-2017" "CPE" "493" "cpe493")
    #("2015-2017" "CPE" "494" "cpe494")
    #("2015-2017" "CPE" "495" "cpe495")
    #("2015-2017" "CPE" "521" "cpe521")
    #("2015-2017" "EE" "521" "cpe521")
    #("2015-2017" "CPE" "522" "cpe522")
    #("2015-2017" "EE" "522" "cpe522")
    #("2015-2017" "CPE" "523" "cpe523")
    #("2015-2017" "EE" "523" "cpe523")
    #("2015-2017" "CPE" "582" "cpe582")))


;; fetch the course mappings from the database
(: fetch-course-mappings (-> (Listof MappingRow)))
(define (fetch-course-mappings)
  (define conn
    (postgresql-connect #:port 13432
                        #:user db-username
                        #:database "scheduling"
                        #:password db-password))
  (define rows
    (query-rows
     conn
     (~a "SELECT * FROM course_mappings")))
  (cast rows (Listof MappingRow)))


;; the rows in the table, representing mappings from offering
;; to canonical name
(define mappings : (Listof MappingRow)
  (cond [use-cached-mappings?
         (printf "WARNING: USED MAPPINGS CACHED ON ~v\n"
                 cache-date)
         cached-mappings]
        [else (fetch-course-mappings)]))


;; a hash table to speed up the mapping, and also to check that the
;; rows that we got from the db conform to the contracts that we
;; specifiye
(define mapping-hash
  (for/hash : (HashTable (Vector CatalogCycle Subject CourseNum)
                         CourseID)
    ([v (in-list mappings)])
    (match-define (vector cycle subject coursenum name) v)
    (unless (coursenum? coursenum)
      (error "unexpected values in db row ~e" v))
    (values (vector cycle subject coursenum) name)))



;; given catalog cycle, subject, and number, return a string
;; representing the canonical course name
(: canonicalize (CatalogCycle Subject CourseNum -> CourseID))
(define (canonicalize cycle subject number)
  (unless (coursenum? number)
    (raise-argument-error 'canonicalize
                          "legal course number"
                          2 cycle subject number))
  (define trimmed-number
    (match number
      [(regexp #px"^0[0-9]{3}" (list _))
       (substring number 1)]
      [other number]))
  (hash-ref mapping-hash (vector cycle subject trimmed-number)
            (位 ()
              (error 'canonicalize
                     "no mapping found for offering: ~e"
                     (list cycle subject number)))))


;; is this string the canonical id of some course?
(define (canonical-id? [n : CourseID]) : Boolean
  (set-member? canonical-ids n))

(define canonical-ids : (Setof CourseID)
  (list->set (hash-values mapping-hash)))

(define (row-name [r : MappingRow]) : String
  (vector-ref r 3))

(define (row-num [r : MappingRow]) : String
  (vector-ref r 2))

;; ensure that a course id is in the canonical list
;; (this defn must be early to allow its use in courses-we-schedule)
(define (ensure-canonical [s : String]) : String
  (cond [(canonical-id? s) s]
        [else (raise-argument-error
               'ensure-canonical
               "canonical course id"
               0 s)]))



;; return the canonical names of all classes in the given catalog offered
;; with the given subject
(: courses-in-subject (CatalogCycle Subject -> (Listof CourseID)))
(define (courses-in-subject cycle subject)
  (remove-duplicates
   (map row-name
        (filter (位 ([r : MappingRow])
                  (and (equal? (vector-ref r 0) cycle)
                       (equal? (vector-ref r 1) subject)))
                mappings))))

;; return all of the mappings for a given class id
(: id-mappings (CourseID -> (Listof (List CatalogCycle Subject CourseNum))))
(define (id-mappings id)
  (define rows
    (filter (位 ([r : MappingRow])
              (equal? (mapping-row-id r) id))
            mappings))
  (map (位 ([r : MappingRow])
         (list (vector-ref r 0)
               (vector-ref r 1)
               (vector-ref r 2)))
       rows))

(module+ test
  (require typed/rackunit)

  (check-equal? (canonicalize "2015-2017" "CPE" "430") "csc430")

  (check-equal? (canonicalize "2015-2017" "CPE" "0430") "csc430"))

